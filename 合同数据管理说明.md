# 合同数据管理说明

## 📋 概述

本项目采用分层架构管理合同数据，确保在JSON文件不可用时，系统仍能正常运行。

## 🏗️ 架构设计

### 1. 数据层 (Data Layer)
- **JSON文件**: `src/main/resources/contracts/` 目录下的合同数据文件
- **硬编码数据**: `ContractDataService` 中的默认合同数据作为备用方案

### 2. 服务层 (Service Layer)
- **ContractDataService**: 负责合同数据的加载、管理和访问
- **自动初始化**: 使用 `@PostConstruct` 在服务启动时自动加载数据

### 3. 控制层 (Controller Layer)
- **GameController**: 处理游戏相关的HTTP请求
- **依赖注入**: 通过 `@Autowired` 注入 `ContractDataService`

## 📁 文件结构

```
src/main/java/com/example/demo/lottery/
├── controller/
│   └── GameController.java          # 游戏控制器
├── service/
│   └── ContractDataService.java     # 合同数据服务
└── resources/
    └── contracts/                   # JSON合同文件目录
        ├── labor-contract.json      # 劳动合同
        ├── housing-lease-contract.json
        ├── purchase-sale-contract.json
        ├── tech-development-contract.json
        └── service-contract.json
```

## 🔄 数据加载流程

### 1. 优先加载JSON文件
```java
@PostConstruct
public void init() {
    loadContractsFromFiles();  // 首先尝试加载JSON文件
}
```

### 2. 备用方案：硬编码数据
```java
private void loadDefaultContracts() {
    // 当JSON文件加载失败时，使用硬编码数据
    CONTRACTS.put(1, new ContractData(...));
    // ... 其他合同
}
```

### 3. 错误处理
- JSON文件缺失 → 自动切换到硬编码数据
- 文件格式错误 → 记录错误日志，使用备用数据
- 网络问题 → 静默失败，不影响用户体验

## 📝 合同数据格式

### JSON文件格式
```json
{
  "id": 1,
  "title": "劳动合同",
  "description": "根据《中华人民共和国劳动法》制定的标准劳动合同",
  "totalErrors": 5,
  "errorIndices": [6, 10, 14, 18, 20],
  "content": [
    "甲方：______",
    "乙方：______",
    // ... 更多内容
  ],
  "errorExplanations": {
    "6": "试用期超过法定最长期限",
    "10": "缺少'及行政法规'",
    // ... 更多说明
  }
}
```

### 硬编码数据格式
```java
new ContractData(
    1,                                    // ID
    "劳动合同",                           // 标题
    "根据《中华人民共和国劳动法》...",     // 描述
    5,                                    // 错误点数量
    Arrays.asList(6, 10, 14, 18, 20),    // 错误索引
    Arrays.asList("甲方：______", ...),    // 合同内容
    Map.of("6", "试用期超过...", ...)     // 错误说明
)
```

## 🛠️ 管理操作

### 1. 重新加载合同数据
```bash
POST /api/game/reload-contracts
```
- 重新读取JSON文件
- 更新内存中的数据
- 返回加载结果

### 2. 获取合同列表
```bash
GET /api/game/contracts
```
- 返回所有可用合同的ID
- 包含合同总数信息

### 3. 获取特定合同
```bash
GET /api/game/contract/{contractId}
```
- 根据ID获取合同详情
- 包含标题、内容、错误点数量

## 🔧 更新合同内容

### 方式1：修改JSON文件（推荐）
1. 编辑 `src/main/resources/contracts/` 下的JSON文件
2. 重启应用或调用重载接口
3. 数据自动更新

### 方式2：修改硬编码数据
1. 编辑 `ContractDataService.java` 中的 `loadDefaultContracts()` 方法
2. 重新编译部署
3. 数据更新完成

### 方式3：热更新（运行时）
1. 修改JSON文件
2. 调用 `POST /api/game/reload-contracts`
3. 无需重启，数据立即生效

## 🚀 优势特性

### 1. 高可用性
- **双重保障**: JSON文件 + 硬编码数据
- **自动降级**: 文件不可用时自动切换
- **零停机**: 支持热更新

### 2. 易维护性
- **集中管理**: 所有合同数据统一管理
- **清晰分层**: 数据、服务、控制层职责明确
- **标准格式**: 统一的合同数据结构

### 3. 灵活性
- **多格式支持**: JSON + Java对象
- **动态加载**: 支持运行时更新
- **向后兼容**: 保持原有API不变

## 📊 性能考虑

### 1. 内存管理
- 合同数据缓存在内存中
- 避免重复文件读取
- 快速响应请求

### 2. 错误处理
- 静默失败，不影响用户体验
- 详细的日志记录
- 优雅的降级策略

### 3. 并发安全
- 静态Map存储，线程安全
- 原子操作更新数据
- 无锁读取，高性能

## 🔍 故障排除

### 1. 合同数据未加载
- 检查JSON文件是否存在
- 验证文件格式是否正确
- 查看应用启动日志

### 2. 重载失败
- 检查文件权限
- 验证JSON语法
- 查看错误日志

### 3. 数据不一致
- 确认文件已保存
- 检查重载接口调用
- 验证数据格式

## 📈 扩展建议

### 1. 数据库存储
- 将合同数据迁移到数据库
- 支持更复杂的查询
- 实现数据版本管理

### 2. 配置化管理
- 支持动态配置合同文件路径
- 实现环境相关的数据配置
- 添加数据验证规则

### 3. 监控告警
- 添加数据加载监控
- 实现异常告警机制
- 记录数据访问统计

---

**注意**: 本系统设计确保在任何情况下都能提供合同数据，为用户提供稳定的游戏体验。
